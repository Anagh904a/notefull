let notes=JSON.parse(localStorage.getItem("notes"))||[],editingNoteIndex=null,currentNoteId=null,currentDeleteNoteId=null,currentItems=[],editingListIndex=null,currentListId=null,historyStack=[],currentIndex=-1,holdTimer=null,selectionMode=!1,selectedNotes=[],notesDirectoryHandle=null,backupDirHandle=null;function debounce(e,t){let n;return function(...s){let i=this;clearTimeout(n),n=setTimeout(()=>e.apply(i,s),t)}}document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelector(".fab-container"),t=document.getElementById("mainFab");document.querySelectorAll(".option-button"),t.addEventListener("click",t=>{t.stopPropagation(),e.classList.toggle("open")}),document.addEventListener("click",t=>{!e.contains(t.target)&&e.classList.contains("open")&&e.classList.remove("open")})}),document.addEventListener("DOMContentLoaded",function(){updateAccountIcon(),startAiScan()});const placeholders=["Search any data...","Ask Notefull AI...","e.g When is my meeting?","Search with Notefull AI...","Quickly find your note...","Find notes by keyword...","What did I write last week?","Locate that important file...","Search through your ideas...","Ask AI for suggestions...","Check your upcoming tasks...","Find meeting notes fast...","Discover your saved thoughts...","Quick search your notes...","Ask Notefull anything...","Where did I save that note?","Search by topic or tag...","Need a reminder? Ask AI...","Look for ideas in your notes...","Search your thoughts quickly...","Find yesterday’s notes...","What notes did I take today?","Quickly find that important detail...","Search for events, tasks, or ideas...","Ask questions about your notes...","Find related notes fast...","Search by keyword or phrase...","AI can help if note isn’t found...","Instantly find any note..."];let index=0;const debouncedSearch=debounce(searchNotes,1e3);document.getElementById("searchInput").addEventListener("input",debouncedSearch);const input=document.getElementById("searchInput");function saveState(){let e=document.getElementById("noteContent").value;currentIndex<historyStack.length-1&&(historyStack=historyStack.slice(0,currentIndex+1)),historyStack.push(e),currentIndex++,toggleButtons()}function undo(){if(currentIndex>0){currentIndex--;let e=historyStack[currentIndex];document.getElementById("noteContent").value=e}toggleButtons()}function redo(){if(currentIndex<historyStack.length-1){currentIndex++;let e=historyStack[currentIndex];document.getElementById("noteContent").value=e}toggleButtons()}function switchTab(e){let t=document.getElementById("addNoteSection"),n=document.getElementById("addListSection"),s=document.getElementById("note-tab"),i=document.getElementById("checklist-tab");"note"===e?(t.style.display="block",n.style.display="none",s.classList.add("data-active"),i.classList.remove("data-active")):(t.style.display="none",n.style.display="block",s.classList.remove("data-active"),i.classList.add("data-active"))}function evaluateInlineFormula(formula){try{if(formula.startsWith("=SUM(")){let nums=formula.slice(5,-1).split(",").map(Number);return nums.reduce((e,t)=>e+t,0)}if(formula.startsWith("=AVG(")){let nums=formula.slice(5,-1).split(",").map(Number);return(nums.reduce((e,t)=>e+t,0)/nums.length).toFixed(2)}if(formula.startsWith("="))return eval(formula.slice(1))}catch(e){}return null}function applySortFilter(){let e=document.getElementById("sortSelect").value,t=document.getElementById("notesContainer"),n=document.getElementById("listsContainerContent");"note"===e?(n.innerHTML="",displayNotes(),document.getElementById("noListsMessage").classList.add("hidden"),showSection("combinedContainer"),console.log("Displaying only notes")):"lists"===e?(t&&(t.innerHTML=""),displayLists(),document.getElementById("noNotesMessage").classList.add("hidden"),showSection("combinedContainer"),console.log("Displaying only lists")):"all"===e?(displayNotes(),displayLists(),showSection("combinedContainer"),console.log("Displaying all notes and lists")):("date_newest"===e||"date_oldest"===e)&&alert("Sorting by date is disabled in this mode.")}function clearData(){confirm("Are you sure you want factory reset? This action cannot be undone.")&&(localStorage.removeItem("notes"),localStorage.removeItem("lists"),displayNotes(),displayLists(),alert("All data cleared successfully! All Settings are also cleared! Next time you would need to complete setup for the app again!")),displayNotes(),displayLists()}function toggleTheme(e){document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e),document.getElementById("themeToggle").checked="light"===e,document.getElementById("themeLabel").textContent="dark"===e?"\uD83C\uDF19 Dark":"☀️ Light"}function toggleButtons(){let e=document.getElementById("undoButton"),t=document.getElementById("redoButton");e.disabled=currentIndex<=0,t.disabled=currentIndex>=historyStack.length-1}setInterval(()=>{input.placeholder=placeholders[index],index=(index+1)%placeholders.length},5e3),switchTab("note"),document.getElementById("noteContent").addEventListener("keyup",function(e){if(" "===e.key||"Enter"===e.key){let t=e.target,n=t.value,s=/=(SUM|AVG)?\(?[0-9+*/,\s.-]+\)?/gi,i=n.match(s);i&&i.forEach(e=>{let n=evaluateInlineFormula(e.trim());null!==n&&(t.value=t.value.replace(e,n))})}}),document.querySelector(".main-fab-style").addEventListener("click",function(e){let t=e.clientX-e.target.getBoundingClientRect().left,n=e.clientY-e.target.getBoundingClientRect().top,s=document.createElement("span");s.className="ripple",s.style.left=`${t}px`,s.style.top=`${n}px`,this.appendChild(s),setTimeout(()=>{s.remove()},600)}),window.addEventListener("DOMContentLoaded",()=>{let e=localStorage.getItem("theme")||"light";toggleTheme(e),document.getElementById("themeToggle").addEventListener("change",function(){toggleTheme(this.checked?"dark":"light")})}),document.getElementById("noteContent").addEventListener("input",saveState),toggleButtons();let isPaused=!1,scanInterval,aiMessages=["Scanning for leaked credentials...","Checking for sensitive keywords...","Validating security integrity...","Analyzing note metadata...","Cross-referencing suspicious terms..."],messageIndex=0;function startAiScan(){let e=document.getElementById("scanStatus"),t=document.getElementById("resultsContainer"),n=document.getElementById("scanCircle"),s=document.getElementById("notesCount"),i=document.getElementById("infoContainer2"),a=document.getElementById("threatsCount");i.style.display="flex",showInfo("You can safely leave this page while the scan completes."),t.innerHTML="",e.textContent="Quick scan in progress... Scanning Notes....",a.textContent="0",n.style.animation="spin 1s linear infinite",n.style.border="",n.style.borderTopColor="rgb(0, 0, 0)",s.textContent="0";let o=document.getElementById("startScanButton");o.textContent="Scanning...",o.classList.add("scanning"),o.disabled=!0;let l=JSON.parse(localStorage.getItem("notes"))||[],d=JSON.parse(localStorage.getItem("sensitiveKeywords")||"null");Array.isArray(d)&&0!==d.length||(d=["password","ssn","credit card","bank account","secret","pin","bank","policy","account","pass","id","aadhaar","card","security","key","token","license","confidential","credentials","auth","login"]);let r=[],c=new Set,u=0,m=0,y=Date.now(),g=setInterval(()=>{if(m>=l.length){clearInterval(g),i.style.display="none";let h=Date.now(),p=((h-y)/1e3).toFixed(2);o.textContent="Start Quick Scan",o.classList.remove("scanning"),o.disabled=!1,s.textContent=`${l.length}`,showAiToast(),0===u?(n.style.borderColor="#4CAF50",e.textContent=`Scan complete in ${p}s — No threats found!`,t.innerHTML="<div class='success-msg'>✅ All notes are safe!</div>"):(n.style.borderColor=1===u?"orange":"red",e.textContent=`Scan complete in ${p}s`,t.innerHTML=r.join("<br>")+'<button class="protect-btn" onclick="redirectProtect()">Protect Now</button>'),t.scrollIntoView({behavior:"smooth"}),n.style.animation="none";return}let I=l[m];if(s.textContent=m+1,I&&(!I.password||""===I.password.trim())){let f=(I.content||"").toLowerCase(),w=I.title||"Untitled",E=d.find(e=>{let t=RegExp(`\\b${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i");return t.test(f)});if(E&&!c.has(w)){let v=/password|credit card|ssn|bank account/.test(E)?"High":"Medium";r.push(`<div class="alert-msg">Sensitive data found in: 
             <strong style="color:red;">${w}</strong>
             <span class="severity ${v.toLowerCase()}">${v}</span>
           </div>`),c.add(w),u++,showToast("Threats Found!");let L=document.getElementById("alertSound");L.play(),a.textContent=u}}m++},100)}function redirectProtect(){alert("Please add a password to sensitive notes yourself — automatic protection is not available.")}function showAiToast(){let e=document.getElementById("aiToast");e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},2e3)}function showNotePassword(){document.getElementById("notePasswordModal").style.display="flex"}function showList(){document.getElementById("listPasswordModalr").style.display="flex"}function closeListPassword(){document.getElementById("listPasswordModalr").style.display="none",dummySaveList()}function closeListPasswordModal(){document.getElementById("listPasswordModal").style.display="none"}function closeDeleteListPasswordModal(){document.getElementById("deleteListPasswordModal").style.display="none",closeListPasswordModal()}function formatDate(e){let t={day:"numeric",month:"long",year:"numeric"};return e.toLocaleDateString("en-US",t)}function highlightSearchTerm(e,t){if(!t)return e;let n=RegExp(`(${t})`,"gi");return e.replace(n,'<span class="highlight">$1</span>')}function displayFilteredNotesAndLists(e,t,n=!1){let s=document.getElementById("notesContainer");s.innerHTML="";let i=document.getElementById("listsContainerContent");i.innerHTML="";let a=document.getElementById("noNotesMessage");a.innerHTML=n?"Searching with AI...":"No matching notes with that title were found.";let o=document.getElementById("noListsMessage");o.innerHTML="No matching lists with that title were found.",0===e.length&&0===t.length?a.classList.remove("hidden"):a.classList.add("hidden"),0===t.length?o.classList.remove("hidden"):o.classList.add("hidden"),e.forEach((e,t)=>{let n=document.createElement("div"),i=new Date(e.date),a=formatDate(i),o=e.password&&""!==e.password?' <i class="fas fa-lock"></i>':"",l=e.password&&""!==e.password?"":`
        <button class="summarize-btn" 
                data-note-content="${e.content}" 
                data-note-title="${e.title}"
                onclick="handleSummarizeButtonClick(this); event.stopPropagation();">
                  
            <i class="fas fa-magic"></i> Summarize Note
        </button>
        `,d=e.password||""!==e.password?`
        <button class="summarize-btn" 
        onclick="alert('Locked notes cannot be summarized due to security reasons'); event.stopPropagation();">
            <i class="fas fa-magic"></i> Summarize Note
        </button>
        `:"",r=highlightSearchTerm(e.title,document.getElementById("searchInput").value.toLowerCase());n.innerHTML=`
        <div class="note" onclick="openNote(${t})">
            <div class="note-header">
                <h4>${r}</h4>
                ${o}
            </div>
            <span class="note-date">${a}</span>
            ${l}
            ${d}
            <button class="delete-btn" onclick="deleteNote(${t}); event.stopPropagation();"><i class="fas fa-trash"></i> Delete</button>
        </div>
        `,s.appendChild(n)}),t.forEach((e,t)=>{let n=document.createElement("div"),i=new Date(e.date),a=formatDate(i),o=e.password&&""!==e.password?' <i class="fas fa-lock"></i>':"",l=highlightSearchTerm(e.title,document.getElementById("searchInput").value.toLowerCase());n.innerHTML=`
     <div class="list" onclick="openList(${t})">    
  <i class="fas fa-list"></i>
  <div class="note-header">
     <h4>${l}</h4>
    ${o}
    </div>
  <span class="list-date">${a}</span>
   <button class="delete-btn" onclick="deleteList(${t}); event.stopPropagation();"><i class="fas fa-trash"></i> Delete</button>
  </div>
        `,s.appendChild(n)})}let aiSearchTimeout;function searchNotes(){clearTimeout(aiSearchTimeout),aiSearchTimeout=setTimeout(()=>{let e=document.getElementById("searchInput").value.toLowerCase().trim();if(""===e)return;let t=notes.filter(t=>t?.title?.toLowerCase().includes(e)),n=lists.filter(t=>t?.title?.toLowerCase().includes(e));0===t.length&&0===n.length?(document.getElementById("searchInput").classList.add("ai-searching"),showToast("Searching with AI..."),searchWithAI(e)):document.getElementById("searchInput").classList.remove("ai-searching"),displayFilteredNotesAndLists(t,n)},1200)}async function searchWithAI(e){console.log("AI search triggered for:",e);let t=document.getElementById("searchInput"),n=notes.slice(-10),s=`Based on the following notes, please answer the question: "${e}". 

Notes:
${n.map(e=>`Title: ${e.title}
Content: ${e.content}`).join("\n\n")}`,i=await callGeminiAPI(s,"AI Search");if(t.classList.remove("ai-searching"),i){let a=n.find(e=>i.includes(e.title));if(a){alert(`AI Answer:

${i}`);let o=notes.findIndex(e=>e.title===a.title);displayFilteredNotesAndLists([notes[o]],[])}else alert(`AI Answer:

${i}`)}else displayFilteredNotesAndLists([],[]),console.log("AI search failed:",i);let l=notes.filter(t=>t?.title?.toLowerCase().includes(e)),d=lists.filter(t=>t?.title?.toLowerCase().includes(e));0===l.length&&0===d.length?noNotesMessage.classList.remove("hidden"):noNotesMessage.classList.add("hidden");let r=document.getElementById("noListsMessage");0===d.length?r.classList.remove("hidden"):r.classList.add("hidden"),l.forEach((e,t)=>{let n=document.createElement("div"),s=new Date(e.date),i=formatDate(s),a=e.password&&""!==e.password?' <i class="fas fa-lock"></i>':"",o=e.password&&""!==e.password?"":`
        <button class="summarize-btn" 
                data-note-content="${e.content}" 
                data-note-title="${e.title}"
                onclick="handleSummarizeButtonClick(this); event.stopPropagation();">
                  
            <i class="fas fa-magic"></i> Summarize Note
        </button>
        `,l=e.password||""!==e.password?`
        <button class="summarize-btn" 
        onclick="alert('Locked notes cannot be summarized due to security reasons'); event.stopPropagation();">
            <i class="fas fa-magic"></i> Summarize Note
        </button>
        `:"",d=highlightSearchTerm(e.title,document.getElementById("searchInput").value.toLowerCase());n.innerHTML=`
        <div class="note" onclick="openNote(${t})">
            <div class="note-header">
                <h4>${d}</h4>
                ${a}
            </div>
            <span class="note-date">${i}</span>
            ${o}
            ${l}
            <button class="delete-btn" onclick="deleteNote(${t}); event.stopPropagation();"><i class="fas fa-trash"></i> Delete</button>
        </div>
        `,container.appendChild(n)}),d.forEach((e,t)=>{let n=document.createElement("div"),s=new Date(e.date),i=formatDate(s),a=e.password&&""!==e.password?' <i class="fas fa-lock"></i>':"",o=highlightSearchTerm(e.title,document.getElementById("searchInput").value.toLowerCase());n.innerHTML=`
     <div class="list" onclick="openList(${t})">    
  <i class="fas fa-list"></i>
  <div class="note-header">
     <h4>${o}</h4>
    ${a}
    </div>
  <span class="list-date">${i}</span>
   <button class="delete-btn" onclick="deleteList(${t}); event.stopPropagation();"><i class="fas fa-trash"></i> Delete</button>
  </div>
        `,container.appendChild(n)})}function onInputChanged(){clearTimeout(aiSearchTimeout),aiSearchTimeout=setTimeout(()=>{let e=document.getElementById("searchInput").value;""!==e.trim()&&searchWithAI(e)},5e3)}function refresh(){displayNotes(),displayLists(),showToast("Refreshed!"),showSection("combinedContainer");let e=document.getElementById("searchInput");e.value=""}function verifyListPassword(){let e=document.getElementById("listPasswordInput").value,t=document.getElementById("listPasswordModal").dataset.listIndex,n=lists[t];if(e===n.password)document.getElementById("listPasswordModal").style.display="none",document.getElementById("listTitle").value=n.title,currentItems=n.items.slice(),displayChecklist(),editingListIndex=t,showAddListSection(),document.getElementById("listPassword").value=n.password;else{showToast("Incorrect password!");let s=document.getElementById("errorSound");s.play()}}function deleteListVerifyPassword(){let e=document.getElementById("deleteListPasswordInput").value,t=document.getElementById("deleteListPasswordModal").dataset.listIndex;console.log("List Index:",t);let n=lists[t];if(!n){console.error("List not found at index:",t);return}if(e===n.password)lists.splice(t,1),localStorage.setItem("lists",JSON.stringify(lists)),document.getElementById("deleteListPasswordModal").style.display="none",document.getElementById("listPasswordModal").style.display="none",displayLists();else{showToast("Incorrect password!");let s=document.getElementById("errorSound");s.play()}}function togglePasswordInput(){let e=document.getElementById("notePassword");e.classList.toggle("hidden")}function showSection(e){document.querySelectorAll(".container").forEach(e=>{e.classList.add("hidden")}),document.getElementById(e).classList.remove("hidden"),historyStack[historyStack.length-1]!==e&&historyStack.push(e),currentSection=e,document.querySelectorAll(".nav__link").forEach(e=>{e.classList.remove("active-link")}),event.currentTarget.classList.add("active-link")}function setEventNav(e){showSection(sectionId),e.currentTarget.classList.add("active-link")}function scrollHeader(){let e=document.getElementById("header");this.scrollY>=80?e.classList.add("scroll-header"):e.classList.remove("scroll-header")}function showAddItem(){addItemSection.classList.remove("hidden"),setTimeout(()=>{addItemSection.classList.add("show")},10)}function navigateTo(e){document.querySelectorAll(".container").forEach(e=>{e.classList.add("hidden")}),document.getElementById(e).classList.remove("hidden"),currentSection=e,closeSidebar()}document.getElementById("searchInput").addEventListener("input",searchNotes),document.getElementById("searchInput").addEventListener("input",onInputChanged),window.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("modal"),t=document.getElementById("closeModal");t.addEventListener("click",()=>{e.style.display="none"})}),window.addEventListener("scroll",scrollHeader),window.addEventListener("popstate",function(e){if(historyStack.length>1){historyStack.pop();let t=historyStack.pop();showSection(t),historyStack.push(t)}}),window.onload=function(){startAiScan()};let isMessageBoxVisible=!1;function showAddNote(){showAddItem(),document.getElementById("noteContent").value="",document.getElementById("notePassword").value="",switchTab("note");let e=document.getElementById("summarize-btn");if(e.disabled=!1,null!==editingNoteIndex){let t=notes[editingNoteIndex];document.getElementById("noteTitle").value=t.title,document.getElementById("noteContent").value=t.content}else document.getElementById("noteTitle").value="",document.getElementById("noteContent").value="";let n=document.getElementById("itemText");n.querySelector("h2").textContent="Create a new Note"}function cancelNote(){hideAddItem(),showSection("combinedContainer"),document.getElementById("notePasswordModal").classList.add("hidden")}function saveNote(){let e=document.getElementById("noteTitle").value.trim(),t=document.getElementById("noteContent").value.trim(),n=document.getElementById("notePassword").value.trim(),s=new Date,i=formatDate(s);if(""===t){showToast("Type some text!");return}if(""===e){showToast("Enter a title!");return}let a={title:e,content:t,password:n,pinned:!1,date:i};null!==editingNoteIndex?(notes[editingNoteIndex]=a,showToast("Saved")):(notes.push(a),showToast("Saved")),localStorage.setItem("notes",JSON.stringify(notes)),syncNoteToIndexedDB(a),displayNotes(),showSection("combinedContainer"),document.getElementById("notePasswordModal").classList.add("hidden");let o=document.getElementById("alertSound");o.play(),editingNoteIndex=null}function syncNoteToIndexedDB(e){if(!db){console.log("No DB");return}let t=localStorage.getItem("syncEnabled");if("true"!==t){console.log("Sync disabled");return}if(e.noteId||(e.noteId=`${e.title}-${Date.now()}`),0===notes.length){console.log("No notes to sync.");return}let n=db.transaction("notes","readwrite");n.objectStore("notes").put(e),localStorage.setItem("lastSynced",new Date().toISOString()),updateLastSyncedDisplay()}function closeNotePassword(){document.getElementById("notePasswordModal").style.display="none"}function showInfo(e){let t=document.getElementById("infoContainer2");document.getElementById("infoText").textContent=e,t.style.display="flex"}async function hashPassword(e){let t=new TextEncoder,n=t.encode(e),s=await crypto.subtle.digest("SHA-256",n),i=Array.from(new Uint8Array(s));return i.map(e=>e.toString(16).padStart(2,"0")).join("")}async function setMasterPassword(e){let t=await hashPassword(e);localStorage.setItem("masterPasswordHash",t),alert("This Feature Is under Development and don't work properly yet"),showToast("Master password set unsuccessfully!")}function displayNotes(){let e=document.getElementById("notesContainer");e.innerHTML="";let t=document.getElementById("noNotesMessage");0===notes.length?t.classList.remove("hidden"):t.classList.add("hidden"),notes.forEach((t,n)=>{let s=document.createElement("div"),i=new Date(t.date),a=formatDate(i),o=t.password&&""!==t.password?' <i class="fas fa-lock"></i>':"",l=t.password&&""!==t.password?"":`
    <button class="summarize-btn" 
            data-note-content="${t.content}" 
            data-note-title="${t.title}"
            onclick="handleSummarizeButtonClick(this); event.stopPropagation();">
              
        <i class="fas fa-magic"></i> Summarize Note
    </button>
  `,d=t.password||""!==t.password?`
    <button class="summarize-btn" 
    onclick="alert('Locked notes cannot be summarized due to security reasons'); event.stopPropagation();">
        <i class="fas fa-magic"></i> Summarize Note
    </button>
  `:"";s.innerHTML=`
   
 <div class="note" onclick="openNote(${n})">
  <div class="note-header">
    <h4>${t.title}</h4>
    ${o}

  </div>
  <span class="note-date">${a}</span>
 ${l}
  ${d}
  <button class="delete-btn" onclick="deleteNote(${n}); event.stopPropagation();"><i class="fas fa-trash"></i> Delete</button>


  </div>
    `,e.appendChild(s)})}function openNote(e){let t=notes[e];t.password?(document.getElementById("passwordModal").style.display="flex",document.getElementById("passwordInput").value="",document.getElementById("passwordModal").dataset.noteIndex=e):showNoteContent(t);let n=document.getElementById("itemText");n.querySelector("h2").textContent="Manage your Note"}function formatSyncTime(e){let t=new Date,n=t-e;if(n<6e4)return"Just now";let s={hour:"numeric",minute:"numeric",hour12:!0},i=t.toDateString()===e.toDateString();return i?`Today at ${e.toLocaleTimeString([],s)}`:e.toLocaleString([],s)}!function(){let e=document.getElementById("globalToast"),t;window.showToast=function(n,s=2500){e&&(clearTimeout(t),e.textContent=n,e.classList.add("show"),t=setTimeout(()=>{e.classList.remove("show")},s))}}(),document.getElementById("addNoteButton").addEventListener("click",function(){editingNoteIndex=null,showAddNote()}),document.addEventListener("DOMContentLoaded",function(){let e=document.querySelectorAll("#settingsTabs button");e.forEach(t=>{t.addEventListener("click",function(){e.forEach(e=>e.classList.remove("active")),this.classList.add("active")})})});const GEMINI_API_KEY="AIzaSyC7v3VTvBq0w_5JqgFGNVO9kmWn0zCeOa4",GEMINI_API_URL=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,aiCache=new Map;let aiAbortController;async function callGeminiAPI(e,t="AI Feature"){if(aiCache.has(e))return showToast(`${t} loaded from cache`,1e3),aiCache.get(e);aiAbortController&&aiAbortController.abort(),aiAbortController=new AbortController;try{let n=[{role:"user",parts:[{text:e}]}],s={contents:n};showToast(`Applying ${t}...`,0);let i=await fetch(GEMINI_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:aiAbortController.signal}),a=await i.json();if(showToast("",1),i.ok&&a.candidates?.[0]?.content?.parts?.[0]?.text){let o=a.candidates[0].content.parts[0].text;return aiCache.set(e,o),showToast(`${t} successful!`,2e3),o}{let l=a.error?.message||"Unknown error or no content.";return showToast(`Error with ${t}: ${l}`,4e3),console.error(`Gemini API Error for ${t}:`,a),null}}catch(d){return"AbortError"===d.name?console.log(`Previous ${t} request aborted.`):(showToast(`Network error for ${t}: ${d.message}`,4e3),console.error(`Fetch error for ${t}:`,d)),null}}async function summarizeNoteWithAI(e){let t=`Summarize the following text concisely:

${e}`;return await callGeminiAPI(t,"Note Summary")}function handleBack(){closeAddItem()}function closeAddItem(){hideAddItem(),showSection("combinedContainer")}async function handleSummarizeButtonClick(e){document.getElementById("noteContent");let t=e.getAttribute("data-note-title")||"Sample Note",n=e.getAttribute("data-note-content");if(n){showToast("Summarizing this note...");let s=await summarizeNoteWithAI(n);showToast("AI is doing it's job!",1),s?alert(`Summary of "${t}": ${s}`,1e4):showToast("Failed to summarize note.",3e3)}else{showToast("No content found to summarize for this note.",3e3);let i=document.getElementById("errorSound");i.play()}}function verifyPassword(){let e=document.getElementById("passwordInput").value,t=document.getElementById("passwordModal").dataset.noteIndex,n=notes[t];if(e===n.password)document.getElementById("passwordModal").style.display="none",showNoteContent(n);else{showToast("Incorrect password!");let s=document.getElementById("errorSound");s.play()}}function deleteVerifyPassword(){let e=document.getElementById("deletePasswordInput").value,t=document.getElementById("deletePasswordModal").dataset.noteIndex,n=notes[t];if(e===n.password)notes.splice(t,1),localStorage.setItem("notes",JSON.stringify(notes)),displayNotes(),closeDeletePasswordModal();else{showToast("Incorrect password!");let s=document.getElementById("errorSound");s.play()}}function showNoteContent(e){document.getElementById("noteTitle").value=e.title,document.getElementById("noteContent").value=e.content,document.getElementById("notePassword").value=e.password,showAddItem(),editingNoteIndex=notes.findIndex(t=>t.title===e.title&&t.content===e.content),switchTab("note");let t=document.getElementById("checklist-tab");t.disabled=!0}function deleteNote(e){let t=notes[e];t.password?(document.getElementById("deletePasswordModal").style.display="flex",document.getElementById("passwordModal").style.display="hidden",document.getElementById("deletePasswordInput").value="",document.getElementById("deletePasswordModal").dataset.noteIndex=e):confirm("Are you sure you want to delete this note?")&&(notes.splice(e,1),localStorage.setItem("notes",JSON.stringify(notes)),displayNotes()),syncNoteToIndexedDB(t),displayNotes()}function closeDeletePasswordModal(){document.getElementById("deletePasswordModal").style.display="none",document.getElementById("deletePasswordInput").value="",document.getElementById("passwordModal").style.display="none"}function closeAddListSection(){hideAddItem(),section.classList.remove("show"),showSection("combinedContainer")}function showAddListSection(){document.querySelectorAll(".container").forEach(e=>{}),showAddItem(),document.getElementById("addListSection").style.display="block",document.getElementById("addNoteSection").style.display="none",switchTab("checklist");let e=document.getElementById("summarize-btn");if(e.disabled=!0,null!==editingListIndex){let t=lists[editingListIndex];document.getElementById("listTitle").value=t.title,currentItems=t.items.slice(),displayChecklist()}else document.getElementById("listTitle").value="",currentItems=[],displayChecklist();let n=document.getElementById("itemText");n.querySelector("h2").textContent="Create a new List"}function cancelList(){currentListId=null,hideAddItem(),showSection("combinedContainer"),displayNotes(),displayLists(),document.getElementById("listPasswordModalr").classList.add("hidden")}function hideAddItem(){addItemSection.classList.remove("show"),setTimeout(()=>{addItemSection.classList.add("hidden")},500)}function saveList(){let e=document.getElementById("listTitle").value.trim(),t=document.getElementById("listPassword").value.trim(),n=new Date,s=formatDate(n);if(""===e||0===currentItems.length){showToast("Enter Data!");let i=document.getElementById("errorSound");i.play();return}let a={title:e,items:JSON.parse(JSON.stringify(currentItems)),password:t,date:s};if(null!==editingListIndex){lists[editingListIndex]=a,showToast("Saved");let o=document.getElementById("alertSound");o.play()}else if(currentListId){let l=lists.findIndex(e=>e.listId===currentListId);-1!==l?lists[l]=a:lists.push(a),showToast("Saved");let d=document.getElementById("alertSound");d.play()}else{lists.push(a),showToast("Saved");let r=document.getElementById("alertSound");r.play()}localStorage.setItem("lists",JSON.stringify(lists)),displayLists(),showSection("combinedContainer"),editingListIndex=null,currentListId=null,document.getElementById("listPasswordModalr").classList.add("hidden"),syncListToIndexedDB(a),cancelNote()}function dummySaveList(){let e=document.getElementById("listTitle").value.trim(),t=document.getElementById("listPassword").value.trim(),n=new Date,s=formatDate(n);if(null!==editingListIndex)lists[editingListIndex].title=e,lists[editingListIndex].items=JSON.parse(JSON.stringify(currentItems)),lists[editingListIndex].password=t;else if(currentListId){let i=lists.find(e=>e.listId===currentListId);i&&(i.title=e,i.items=JSON.parse(JSON.stringify(currentItems)))}else{currentListId=`draft-list-${Date.now()}`;let a={listId:currentListId,title:e,items:JSON.parse(JSON.stringify(currentItems)),password:t,date:s};lists.push(a)}localStorage.setItem("lists",JSON.stringify(lists))}function syncListToIndexedDB(e){if(console.log("Trying to sync list to IndexedDB..."),!db)return;let t=localStorage.getItem("syncEnabled");if("true"!==t)return;e.listId||(e.listId=`${e.title}-${Date.now()}`);let n=db.transaction("lists","readwrite");n.objectStore("lists").put(e),localStorage.setItem("lastSynced",new Date().toISOString()),updateLastSyncedDisplay()}function updateLastSyncedDisplay(){let e=document.getElementById("lastSyncedStatus"),t=localStorage.getItem("lastSynced");if(!e)return;if(!t){e.innerText='<i class="fas fa-clock"></i> Last Synced: Never';return}let n=new Date(t);e.innerHTML=`<i class="fas fa-clock"></i> Last Synced: ${formatSyncTime(n)}`}function openList(e){let t=lists[e];t.password?(document.getElementById("listPasswordModal").dataset.listIndex=e,document.getElementById("listPasswordModal").style.display="flex",document.getElementById("listPasswordInput").value=""):(document.getElementById("listTitle").value=t.title,currentItems=t.items.slice(),displayChecklist(),editingListIndex=e,showAddListSection(),document.getElementById("listPassword").value=t.password);let n=document.getElementById("itemText");switchTab("checklist");let s=document.getElementById("note-tab");s.disabled=!0,n.querySelector("h2").textContent="Manage your List"}document.addEventListener("keydown",function(e){"Escape"===e.key&&(e.preventDefault(),closeAddItem())}),document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".container").forEach(e=>{e.classList.add("hidden")}),showSection("combinedContainer"),displayNotes(),displayLists()}),document.getElementById("addListButton").addEventListener("click",function(){editingListIndex=null,showAddListSection()});const lists=JSON.parse(localStorage.getItem("lists"))||[];function showListsSection(){showSection("combinedContainer"),displayLists()}function addItem(){let e=document.getElementById("newItem"),t=e.value.trim();if(""===t){showToast("Item cannot be empty");let n=document.getElementById("errorSound");n.play();return}currentItems.push({name:t,checked:!1}),e.value="",displayChecklist(),dummySaveList()}function closePasswordModal(){document.getElementById("passwordModal").style.display="none",document.getElementById("passwordInput").value=""}function openTab(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.add("hidden")),document.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active-tab")),document.getElementById(e).classList.remove("hidden");let t=document.querySelectorAll("#settingsTabs button");t.forEach(t=>{t.getAttribute("onclick").includes(e)&&t.classList.add("active-tab")})}function restoreFromIndexedDB(){let e=document.getElementById("restoreOverlay");e.style.display="flex";let t=confirm("Do you want to restore the backup? This will overwrite your current notes and lists. We are working on a more advanced restore feature soon!");if(!t){e.style.display="none";return}setTimeout(()=>{let t=db.transaction("notes","readonly"),n=t.objectStore("notes"),s=[];n.openCursor().onsuccess=function(t){let n=t.target.result;if(n){let i=n.value,a=(i.title||"").trim(),o=(i.content||"").trim();(""!==a||""!==o)&&s.push(i),n.continue()}else{localStorage.setItem("notes",JSON.stringify(s));let l=db.transaction("lists","readonly"),d=l.objectStore("lists"),r=[];d.openCursor().onsuccess=function(t){let n=t.target.result;if(n){let s=n.value,i=(s.title||"").trim(),a=Array.isArray(s.items)?s.items:[];(""!==i||a.length>0)&&r.push(s),n.continue()}else{localStorage.setItem("lists",JSON.stringify(r)),e.style.display="none",showToast("Data restored from Secondory Storage!");let o=document.getElementById("alertSound");o.play()}}}}},3e3),displayNotes(),displayLists(),updateLastSyncedDisplay()}function displayChecklist(){let e=document.getElementById("checklistContainer");e.innerHTML="",currentItems.forEach((t,n)=>{let s=document.createElement("div");s.innerHTML=`

<div class="checklist-item">
  -><input type="checkbox" id="item-${n}" ${t.checked?"checked":""} onchange="toggleCheck(${n})">
  <label for="item-${n}">${t.name}</label>
  <button onclick="removeItem(${n})"><i class="fas fa-trash"></i> Remove</button>
</div>

`,e.appendChild(s)})}function toggleCheck(e){currentItems[e].checked=!currentItems[e].checked}function removeItem(e){currentItems.splice(e,1),displayChecklist()}function displayLists(){let e=document.getElementById("listsContainerContent");e.innerHTML="";let t=document.getElementById("noListsMessage");0===lists.length?t.classList.remove("hidden"):t.classList.add("hidden"),lists.forEach((t,n)=>{let s=document.createElement("div"),i=new Date(t.date),a=formatDate(i),o=t.password&&""!==t.password?' <i class="fas fa-lock"></i>':"",l="";if(t.items&&t.items.length>0){let d=t.items.length,r=t.items.filter(e=>e.checked).length,c=r/d*100;l=`
        <div class="list-progress">
   <small>${Math.round(c)}% Completed</small>
        <progress value="${c}" max="100" id="list-bar"></progress>
 </div>
      `}s.innerHTML=`
  <div class="list" onclick="openList(${n})">    
  <i class="fas fa-list"></i>
  <div class="note-header">
    <h4>${t.title}</h4>
    ${o}
    </div>
  <span class="list-date">${a}</span>
  ${l} 
  <button class="delete-btn" onclick="deleteList(${n}); event.stopPropagation();"><i class="fas fa-trash"></i> Delete</button>
  </div>
  `,e.appendChild(s)})}function deleteList(e){let t=lists[e];t.password?(document.getElementById("deleteListPasswordModal").style.display="flex",document.getElementById("deleteListPasswordModal").dataset.listIndex=e):confirm("Are you sure you want to delete this list?")&&(lists.splice(e,1),localStorage.setItem("lists",JSON.stringify(lists)),displayLists()),syncListToIndexedDB(t),displayLists()}function toggleSync(e){let t=e.checked;localStorage.setItem("syncEnabled",t?"true":"false");let n=document.getElementById("syncStatus");n&&(n.innerText=t?"✅ Sync is ON":"\uD83D\uDD04 Sync is OFF")}document.addEventListener("keydown",function(e){"Escape"===e.key&&closePasswordModal()}),document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("syncToggle"),t=localStorage.getItem("syncEnabled");if(e){null===t||"false"===t?e.checked=!1:e.checked=!0;let n=document.getElementById("syncStatus");n&&(n.innerText=e.checked?"✅ Sync is ON":"\uD83D\uDD04 Sync is OFF")}});const VERSION="v1.2";function openAntithreat(){showSection("antithreatSection");let e=localStorage.getItem("lastUpdated"),t=localStorage.getItem("version")||"v1.0";document.getElementById("lastUpdated").textContent=e||"Outdated",document.getElementById("currentVersion").textContent=t;let n=Date.now(),s=2592e5;!e||n-parseInt(e)>s?document.getElementById("updateButton").classList.remove("hidden"):document.getElementById("updateButton").classList.add("hidden")}function updateAccountIcon(){let e=localStorage.getItem("notesAppUser"),t=document.getElementById("account-icon");if(e&&t){let n=e.trim().charAt(0).toUpperCase();t.textContent=n,t.onclick=()=>{alert(`Account: ${e}
`)};let s=document.getElementById("usernameInput");s&&(s.value=e)}}function saveProfile(){let e=document.getElementById("usernameInput"),t=document.getElementById("profile-msg");if(e&&""!==e.value.trim()){let n=e.value.trim();localStorage.setItem("notesAppUser",n),updateAccountIcon(),t.textContent="Profile updated successfully!",setTimeout(()=>t.textContent="",3e3)}else t.textContent="Please enter a valid name."}function openAntithreat(){showSection("antithreatSection");let e=localStorage.getItem("lastUpdated"),t=localStorage.getItem("version")||"v1.0";document.getElementById("lastUpdated").textContent=e||"Outdated",document.getElementById("currentVersion").textContent=t;let n=Date.now(),s=2592e5;!e||n-parseInt(e)>s?document.getElementById("updateButton").classList.remove("hidden"):document.getElementById("updateButton").classList.add("hidden")}async function startUpdate(){let e=document.getElementById("updateModal"),t=document.getElementById("updateStatus"),n=document.getElementById("updateButton");e.style.display="flex",n.disabled=!0;let s="Preparing updates",i=0,a=setInterval(()=>{i=(i+1)%4,t.textContent=s+".".repeat(i)},500);setTimeout(()=>s="Downloading update",5e3),setTimeout(()=>s="Installing update",2e4);try{await new Promise(e=>setTimeout(e,45e3)),clearInterval(a),t.textContent="Finalizing...";let o=await fetch("https://raw.githubusercontent.com/Anagh904a/notefull/refs/heads/main/sensitiveKeywords.json");if(!o.ok)throw Error(`HTTP ${o.status}`);let l=await o.json();localStorage.setItem("sensitiveKeywords",JSON.stringify(l)),console.log("✅ Keywords updated:",l);let d=localStorage.getItem("version")||"v1.0",r=getNextVersion(d);localStorage.setItem("version",r),localStorage.setItem("lastUpdated",Date.now()),t.textContent="Update completed successfully!",setTimeout(()=>{e.style.display="none",openAntithreat(),alert("Database Updated — Now running a quick scan..."),startAiScan()},2e3)}catch(c){clearInterval(a),t.textContent="Update failed. Please try again.",console.error("❌ Update error:",c),alert("Failed to fetch update. Please check your internet connection.")}finally{n.disabled=!1}}function getNextVersion(e){let[t,n]=e.replace(/^v/i,"").split(".").map(Number);return++n>=10&&(t++,n=0),`v${t}.${n}`}async function fixNote(){let e=document.getElementById("noteContent"),t=e.value;if(""===t.trim()){showToast("There is no content to fix.");return}let n=`Please fix the grammar and spelling of the following text and don't not share any explaination just in your answer the corrected text as you are being used as a summarizer feature:

${t}`,s=await callGeminiAPI(n,"Note Fixer");s?(e.value=s,showToast("Note content has been fixed!")):showToast("Failed to fix the note content.")}document.addEventListener("DOMContentLoaded",updateAccountIcon),window.onload=function(){let e=parseInt(localStorage.getItem("lastUpdated"),10),t=Date.now(),n=2592e5;(!e||t-e>n)&&showToast("New Definitions Available!")},displayLists(),displayNotes();